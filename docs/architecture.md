## 系统架构文档（Architecture）

> 版本：v1.0  
> 更新时间：2025年 12月 16日 星期二 16:54:20 CST  
> 说明：本文件基于 `readme.md` 的系统介绍，仅描述架构与模块关系，不涉及具体实现细节。

---

### 1. 整体架构概览

系统采用**分层 + 微服务 + 消息驱动**的架构，整体自下而上划分为：

- **现场设备层（Field Layer）**  
  - 各类工业现场设备：PLC（如西门子）、各类仪表设备（流量、温度等）。  
  - 通过各类工业现场总线或专有协议（Modbus、Profibus、Profinet 等）与 OPC UA 网关连接。

- **现场接入层 / OPC UA 网关层（Gateway Layer）**  
  - 由 KepserverEx 等工业网关组成。  
  - 负责将多种现场协议统一转换为 OPC UA 协议，并在 OPC 地址空间中暴露设备与 Tag。  

- **数据采集层（Ingestion Layer）**  
  - 由多节点组成的 **OPC UA 采集集群**（Active / Standby 冗余）。  
  - 每个节点内部包含：连接管理、会话与订阅管理、数据缓存与上送、故障检测与主备切换协同等子模块。  
  - 通过 OPC UA Client 与网关建立会话，订阅大量 Tag 的数据变化，并将变化数据封装为统一数据点后发送至消息总线。  

- **数据处理与存储层（Processing & Storage Layer）**  
  - **消息队列子层**：Kafka 集群，作为系统的核心解耦层与缓冲层。  
  - **实时处理子层**：实时计算服务、在线规则引擎、数据清洗服务。  
  - **离线处理子层**：批处理引擎，用于大批量历史数据分析和报表生成。  
  - **存储子层**：Redis 作为高性能缓存，MySQL 作为长期历史数据存储（时间分表）。  

- **数据服务层（Data Service Layer）**  
  - 查询 API 服务：对外提供统一的 REST / gRPC 接口，用于实时/历史数据查询、统计分析。  
  - 告警服务：基于规则的告警判定、告警状态管理与通知分发。  
  - 统计服务：提供聚合统计、趋势分析、报表生成等能力。  

- **监控与运维层（Observability & Ops Layer）**  
  - 指标采集：系统级、应用级、业务级指标的统一采集。  
  - 告警与事件：通过 Prometheus 规则等对异常进行告警。  
  - 运维工具：部署脚本、健康检查脚本、故障演练脚本等。  

- **上层应用层（EMS / Web 监控中心）**  
  - 工业 EMS 系统、Web 监控大屏等，通过 HTTP / WebSocket 调用数据服务层接口，进行可视化展示与调度控制。  

---

### 2. 逻辑视图与模块划分

#### 2.1 现场设备与 OPC UA 网关

- **现场设备模块**  
  - 职责：提供原始工业信号与状态数据（电流、电压、温度、压力、流量、开关量等）。  
  - 与上游关系：通过现场总线或专有协议接入 OPC UA 网关。  

- **OPC UA 网关模块（KepserverEx）**  
  - 职责：将多种工业协议抽象为统一的 OPC UA 地址空间。  
  - 对外接口：  
    - 向采集集群提供 OPC UA Server 接口（包括会话管理、节点浏览、订阅、监控项推送）。  
  - 与上游/下游关系：  
    - 上游：连接多个现场设备；  
    - 下游：被一个或多个 OPC UA 采集节点订阅。  

#### 2.2 数据采集层（OPC UA 采集集群）

采集集群按角色划分为 **Active 节点** 与 **Standby 节点**：

- **连接与会话管理子模块**  
  - 维护与一个或多个 OPC UA Server 的连接与会话（Session）。  
  - 负责会话建立、断线检测、重连与会话恢复。  

- **订阅与监控项管理子模块**  
  - 按配置为不同数据源创建多个 Subscription，并在每个 Subscription 下注册若干 MonitoredItem（Tag）。  
  - 管理订阅生命周期（创建、修改、删除），并支持动态变更采样周期、死区策略等。  

- **数据缓冲与上送子模块**  
  - 接收来自 OPC UA Server 的数据变化通知。  
  - 将原始变化转换为统一的数据点结构，写入内部缓冲队列。  
  - 按批次将数据点推送至消息总线（Kafka），以提升吞吐并控制网络开销。  

- **主备协调与健康检查子模块**  
  - 通过心跳机制和分布式锁（基于 Redis 等）维护 Active / Standby 角色。  
  - 负责在 Active 节点故障时快速触发 Standby 接管，并保证对外只存在一个有效的生产者角色。  

#### 2.3 消息总线（Kafka 集群）

- **Kafka Broker 集群**  
  - 职责：为采集集群、清洗服务、实时/离线处理服务提供高吞吐、可持久化、可回放的数据管道。  
  - 主题划分示例：  
    - `opcua-data`：原始采集数据点。  
    - `cleaned-data`：经过清洗与转换后的标准化数据。  
    - `aggregated-metrics`：聚合后的统计结果。  
  - 特性：  
    - 提供分区与副本机制，提升扩展性与容错能力。  
    - 支持“至少一次”投递语义与消费位点管理。  

#### 2.4 数据处理与存储层

- **实时计算服务模块**  
  - 从 `opcua-data` / `cleaned-data` 等 Topic 消费数据。  
  - 实时执行规则判断、阈值告警预判、在线聚合（如窗口平均值、最大/最小值）。  
  - 将计算结果写入 Redis（用于快速查询）或写回 Kafka 供其他下游使用。  

- **数据清洗模块**  
  - 输入：来自 Kafka 的原始数据点流。  
  - 职责：  
    - 校验数据质量（合法值域、时间戳合理性、质量标记等）。  
    - 实现数值平滑、单位换算、缺失值填补、去重与乱序纠正。  
  - 输出：写入 `cleaned-data` Topic 或直接写入 Redis / MySQL。  

- **批处理引擎模块**  
  - 周期性从 Kafka / MySQL 抽取大批量数据进行复杂分析与报表计算。  
  - 典型任务：能耗分析、产量统计、设备运行时长统计等。  
  - 输出可写回数据库、生成报表文件或推送至 BI/报表系统。  

- **Redis 缓存模块**  
  - 角色：高速读写缓存层。  
  - 存储内容：  
    - 各 Tag 的最新值及近期一段时间的关键指标。  
    - 告警状态、规则配置缓存、会话信息等高频访问数据。  
  - 特性：  
    - 使用合理的过期策略（如 TTL=10 分钟）防止内存膨胀。  

- **MySQL 存储模块**  
  - 角色：结构化历史数据存储。  
  - 表结构：按时间分表（如按月/按日），并建立复合索引（设备ID + 时间）。  
  - 写入模式：  
    - 通过批处理任务进行批量写入，减少单条插入开销。  
  - 读取模式：  
    - 提供给数据服务层的历史查询与报表生成。  

#### 2.5 数据服务层

- **查询 API 服务模块**  
  - 封装对 Redis + MySQL 的访问逻辑，对外提供统一的查询接口：  
    - 查询某 Tag 的最新值及质量信息。  
    - 按时间范围查询时序数据。  
    - 获取聚合统计（如平均值、极值、分位数等）。  
  - 负责权限控制、参数校验、节流限流、结果缓存等。  

- **告警服务模块**  
  - 管理告警规则（创建、修改、启停）。  
  - 从实时计算结果或直接从数据流中读取指标，执行告警判定。  
  - 生成告警事件，并推送到上层系统或通知通道（邮件、短信、IM 等）。  

- **统计服务模块**  
  - 面向业务场景提供封装好的统计接口：  
    - 按产线/设备统计能耗、产量、合格率等。  
    - 提供报表下载或接口输出。  

#### 2.6 监控与运维层

- **监控采集模块**  
  - 从各服务导出端点（如 Prometheus metrics）采集指标：  
    - 系统级：CPU、内存、磁盘 IO、网络带宽。  
    - 应用级：采集延迟、Kafka 消息积压、Redis 命中率、数据库 QPS 等。  
    - 业务级：设备在线率、告警数量、数据完整性等。  

- **告警与可视化模块**  
  - 基于 `alerting/rules.yaml` 等规则定义，实现多种异常场景告警（如 `HighDataLatency`、`KafkaConsumerLag`）。  
  - 在可视化平台（如 Grafana）中展示关键指标与告警状态。  

- **运维与故障演练模块**  
  - 提供标准化脚本：  
    - 一键部署与升级（Docker / Docker Compose / CI Pipeline）。  
    - 网络中断、节点故障、服务重启等故障场景的演练脚本。  
  - 支持基于演练结果优化高可用策略与告警规则。  

---

### 3. 部署视图

- **容器化部署**  
  - 所有核心服务（采集节点、Kafka、Redis、MySQL、API 服务、告警服务等）通过 Docker 镜像打包。  
  - 使用 Docker Compose / 容器编排工具统一管理服务生命周期、网络与存储卷。  

- **网络拓扑**  
  - 现场网络：现场设备与 OPC UA 网关位于工业控制网或生产网。  
  - 生产业务网：采集集群、Kafka、Redis、MySQL、数据服务与监控系统部署在生产业务网或专用数据中心网络。  
  - 访问边界：EMS / Web 监控中心通过受控的 HTTP / WebSocket 接口访问数据服务层。  

---

### 4. 模块间依赖与扩展点

- **解耦点：消息队列（Kafka）**  
  - 采集层与处理/存储层通过 Topic 解耦，便于后续增加新的处理服务（如机器学习服务、预测性维护模块）。  

- **可插拔的数据源与处理器**  
  - 通过在采集层增加新的 DataSource 配置，可无侵入地接入新的 OPC UA Server 或 Tag。  
  - 通过增加新的 Kafka Consumer 服务，可以扩展新的业务处理逻辑，不影响现有链路。  

- **可扩展的监控与告警规则**  
  - 告警规则通过配置文件或规则引擎维护，可在不停机的情况下动态调整。  

---

### 5. 边界与约束说明

- **不在本架构文档范围内的内容：**  
  - 具体 C++ 类、函数、数据结构实现细节。  
  - 数据库具体表结构、索引字段细节。  
  - UI/前端实现细节。  

- **关键非功能性指标（来自项目目标）：**  
  - 采集延迟：\< 100ms。  
  - 吞吐能力：单节点 ≥ 10k msg/s。  
  - 可用性：≥ 99.95%。  
  - 故障自动恢复时间：\< 30s。  
  - 数据完整性：≥ 99.99%。  


